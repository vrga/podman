# {{ ansible_managed }}
# {{ item.name | mandatory }}

[Unit]
Description=Podman {{ item.name | mandatory }} service
Documentation=man:podman-generate-systemd(1)
Wants=network.target
After=network-online.target

[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=always
ExecStartPre=/bin/rm -f %t/%n-pid %t/%n-cid
ExecStartPre=-/usr/bin/podman rm {{ item.name | mandatory }}
ExecStart=/usr/bin/podman run --conmon-pidfile %t/%n-pid --cidfile %t/%n-cid --cgroups=no-conmon -d --name {{ item.name | mandatory }} \
--network {{ item.network | default('podman') }} \
{% if item.user is defined and item.user != "" and item.group is defined and item.group != "" -%}
    --user {{ item.user }}:{{ item.group }} \
{% endif -%}
{% for expose in item.exposes | default([]) -%}
    -p {{ expose }} \
{% endfor -%}
{% for envvar in item.environment | default([]) -%}
    -e {{ envvar }} \
{% endfor -%}
{% for mount in item.mounts | default([]) -%}
    -v {{ mount }} \
{% endfor -%}
{{ item.extra_args | default('') }} {{ item.image | mandatory }} {{ item.parameters | default('') }}
ExecStop=/usr/bin/podman stop --ignore --cidfile %t/%n-cid -t 10
ExecStopPost=/usr/bin/podman rm --ignore -f --cidfile %t/%n-cid
PIDFile=%t/%n-pid
KillMode=none
Type=forking

[Install]
WantedBy=multi-user.target default.target